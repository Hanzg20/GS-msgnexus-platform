# Prisma Schema åä½œå¼€å‘æ–‡æ¡£

## ğŸ¤ å¼€å‘è€…åä½œçŠ¶æ€

**ç¬¬ä¸€ä¸ªå¼€å‘è€…**: å·²è®¾ç½®åŸºç¡€ Prisma é…ç½®
**ç¬¬äºŒä¸ªå¼€å‘è€…**: å·²å®Œæˆå®Œæ•´æ•°æ®æ¨¡å‹è®¾è®¡

## ğŸ“‹ è®¾è®¡æ¦‚è¿°

åŸºäºç°æœ‰çš„ Feathers.js æ¶æ„ï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ªå®Œæ•´çš„å¤šç§Ÿæˆ·æ¶ˆæ¯ç³»ç»Ÿ Schemaï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒæ¨¡å—ï¼š

### 1. å¤šç§Ÿæˆ·ç³»ç»Ÿ (Tenant)
- **åŠŸèƒ½**: æ”¯æŒ SaaS å¤šç§Ÿæˆ·æ¶æ„
- **å…³é”®å­—æ®µ**: 
  - `subdomain`: å­åŸŸåæ”¯æŒ
  - `apiKey`: API å¯†é’¥ç®¡ç†
  - `planType`: è®¢é˜…è®¡åˆ’ç±»å‹
  - `settings`: ç§Ÿæˆ·é…ç½® (JSON)

### 2. ç”¨æˆ·ç³»ç»Ÿ (User)
- **åŠŸèƒ½**: å¤šç§Ÿæˆ·ç”¨æˆ·ç®¡ç†
- **å…³é”®ç‰¹æ€§**:
  - ç§Ÿæˆ·éš”ç¦» (`tenantId`)
  - å¤–éƒ¨ç”¨æˆ· ID æ”¯æŒ (`externalUserId`)
  - å”¯ä¸€çº¦æŸ: `[tenantId, externalUserId]`

### 3. å¯¹è¯ç³»ç»Ÿ (Conversation + ConversationParticipant)
- **åŠŸèƒ½**: æ”¯æŒå¤šç§å¯¹è¯ç±»å‹
- **å¯¹è¯ç±»å‹**: direct (ç§èŠ), group (ç¾¤èŠ), channel (é¢‘é“)
- **å‚ä¸è€…ç®¡ç†**: è§’è‰²ç³»ç»Ÿ (owner, admin, member)

### 4. æ¶ˆæ¯ç³»ç»Ÿ (Message)
- **åŠŸèƒ½**: å®Œæ•´çš„æ¶ˆæ¯ç®¡ç†
- **æ¶ˆæ¯ç±»å‹**: text, image, file, system
- **çŠ¶æ€è·Ÿè¸ª**: sent, delivered, read, failed
- **å›å¤åŠŸèƒ½**: æ”¯æŒæ¶ˆæ¯å›å¤é“¾
- **å…ƒæ•°æ®**: æ‰©å±•å­—æ®µæ”¯æŒ

### 5. Webhook ç³»ç»Ÿ (Webhook)
- **åŠŸèƒ½**: äº‹ä»¶é€šçŸ¥ç³»ç»Ÿ
- **äº‹ä»¶ç±»å‹**: message.created, user.joined ç­‰
- **å®‰å…¨**: å¯†é’¥éªŒè¯

### 6. ç³»ç»Ÿé…ç½® (SystemConfig)
- **åŠŸèƒ½**: å…¨å±€é…ç½®ç®¡ç†
- **ç”¨é€”**: ç³»ç»Ÿçº§è®¾ç½®å­˜å‚¨

## ğŸ”— å…³ç³»è®¾è®¡

### æ ¸å¿ƒå…³ç³»
```
Tenant (1) â†â†’ (N) User
Tenant (1) â†â†’ (N) Conversation  
Tenant (1) â†â†’ (N) Message
Tenant (1) â†â†’ (N) Webhook

User (1) â†â†’ (N) Message
User (N) â†â†’ (N) Conversation (é€šè¿‡ ConversationParticipant)

Conversation (1) â†â†’ (N) Message
Message (1) â†â†’ (N) Message (å›å¤å…³ç³»)
```

### çº§è”åˆ é™¤ç­–ç•¥
- ç§Ÿæˆ·åˆ é™¤æ—¶ï¼Œçº§è”åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
- ç”¨æˆ·åˆ é™¤æ—¶ï¼Œçº§è”åˆ é™¤ç”¨æˆ·çš„æ¶ˆæ¯å’Œå‚ä¸å…³ç³»
- å¯¹è¯åˆ é™¤æ—¶ï¼Œçº§è”åˆ é™¤æ‰€æœ‰æ¶ˆæ¯å’Œå‚ä¸è€…

## ğŸ“Š ç´¢å¼•ä¼˜åŒ–

### æ€§èƒ½ç´¢å¼•
- `[tenantId, conversationId, createdAt]` - æ¶ˆæ¯æŸ¥è¯¢ä¼˜åŒ–
- `[tenantId, email]` - ç”¨æˆ·æŸ¥è¯¢ä¼˜åŒ–  
- `[tenantId, type, createdAt]` - å¯¹è¯æŸ¥è¯¢ä¼˜åŒ–
- `[senderId, createdAt]` - ç”¨æˆ·æ¶ˆæ¯å†å²

## ğŸš€ ä¸‹ä¸€æ­¥åä½œå»ºè®®

### 1. æ•°æ®åº“è¿ç§»
```bash
# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npx prisma generate

# åˆ›å»ºè¿ç§»æ–‡ä»¶
npx prisma migrate dev --name init-messagecore-schema

# æ¨é€åˆ°æ•°æ®åº“
npx prisma db push
```

### 2. éœ€è¦ç¬¬ä¸€ä¸ªå¼€å‘è€…ç¡®è®¤çš„åŠŸèƒ½
- [ ] ç§Ÿæˆ·æ¨¡å‹è®¾è®¡æ˜¯å¦æ»¡è¶³éœ€æ±‚
- [ ] å¯¹è¯ç±»å‹æ˜¯å¦å®Œæ•´ (direct/group/channel)
- [ ] æ¶ˆæ¯çŠ¶æ€æµè½¬æ˜¯å¦åˆç†
- [ ] Webhook äº‹ä»¶ç±»å‹å®šä¹‰

### 3. å¾…å®Œå–„åŠŸèƒ½
- [ ] æ¶ˆæ¯é™„ä»¶ç³»ç»Ÿ (File æ¨¡å‹)
- [ ] ç”¨æˆ·æƒé™ç³»ç»Ÿ (Permission æ¨¡å‹)
- [ ] æ¶ˆæ¯æœç´¢ç´¢å¼•
- [ ] å®¡è®¡æ—¥å¿—ç³»ç»Ÿ (AuditLog æ¨¡å‹)

### 4. ä¸ Feathers.js é›†æˆ
- [ ] æ›´æ–° TypeBox schemas ä»¥åŒ¹é… Prisma æ¨¡å‹
- [ ] åˆ›å»º Prisma æœåŠ¡é€‚é…å™¨
- [ ] è¿ç§»ç°æœ‰ Knex æ•°æ®åˆ° Prisma

## ğŸ’¡ è®¾è®¡äº®ç‚¹

1. **å¤šç§Ÿæˆ·éš”ç¦»**: æ‰€æœ‰æ¨¡å‹éƒ½åŒ…å« `tenantId`ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
2. **æ‰©å±•æ€§**: ä½¿ç”¨ JSON å­—æ®µå­˜å‚¨é…ç½®å’Œå…ƒæ•°æ®
3. **æ€§èƒ½ä¼˜åŒ–**: åˆç†çš„ç´¢å¼•è®¾è®¡
4. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript æ”¯æŒ
5. **å‘åå…¼å®¹**: ä¿æŒä¸ç°æœ‰ Feathers.js æ¨¡å‹çš„å…¼å®¹æ€§

## ğŸ”§ å¼€å‘å·¥å…·

### Prisma Studio
```bash
npx prisma studio
```

### æ•°æ®åº“é‡ç½®
```bash
npx prisma migrate reset
```

### ç”Ÿæˆç±»å‹
```bash
npx prisma generate
```

---

**åä½œçŠ¶æ€**: ç­‰å¾…ç¬¬ä¸€ä¸ªå¼€å‘è€…å®¡æŸ¥å’Œç¡®è®¤
**æœ€åæ›´æ–°**: 2024-01-XX
**ç‰ˆæœ¬**: v1.0.0 